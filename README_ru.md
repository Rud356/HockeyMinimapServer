# HockeyMinimapServer
[EN version of README.md](README.md)
Данный проект предназначен для частичной автоматизации отслеживания игроков на хоккейном поле на основании
видеозаписи со статически расположенной камеры.

## Предварительные требования
### Системные требования:

| Параметр                   | Минимальные требования                  | Рекомендуемые требования                  |
|----------------------------|-----------------------------------------|-------------------------------------------|
| **Платформа**              | Windows 10, Linux                       | Windows 10, Linux                         |
| **Разрядность**            | 64-бит                                  | 64-бит                                    |
| **Процессор**              | Не менее 3.8 ГГц с 4 ядрами             | 4 ГГц или быстрее с 8 ядрами или более    |
| **Видеоадаптер**           | -                                       | Nvidia RTX 3050 8GB                       |
| **Оперативная память**     | 8 ГБ                                    | 16 ГБ оперативной памяти                  |
| **Контроллер**             | Клавиатура и компьютерная мышь          | Клавиатура и компьютерная мышь            |
| **Место на жестком диске** | 50 ГБ свободного пространства           | 120 ГБ свободного пространства            |

**Системные требования к жесткому диску предполагают наличие пространства для хранения проектов.** 

**Требуется подключение к интернету для загрузки сторонней модели ResNet18 из библиотеки pytorch при первом запуске,
а также для установки проекта** 

### Требуемое программное обеспечение
   * Git;
   * Система сборки ninja build;
   * FFMpeg > 6.0 (для Windows `winget install ffmpeg` один из доступных вариантов установки);
   * Python 3.11 или выше (желательно 3.11) в зависимости от поддержки новых версий языка библиотеками;
   * Windows Terminal запускаемый в режиме PowerShell.

#### ПО специфичное для Windows
   * Visual Studio 2022 вместе с C++ development kit.

#### ПО специфичное для Linux
   * Компиляторы g++ и gcc;
   * Для аппаратного ускорения на видеокартах Nvidia требуется установка проприетарный драйверов;
   * Установленные пакеты разработчика для языка Python (`python3-dev` в случае Debian-based дистрибутивов). 

### Подготовка для Windows:
   - Добавить в системную переменную пути PATH следующее значение, с подстановкой <version>:
     `C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\<version>\bin\Hostx64\x64`;
   - Включить возможность запуска подписанных скриптов командой в PowerShell
     `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser`.
     > Требуется для запуска виртуальных окружений и сборки.

### Подготовка Linux:
   - Установить python3-dev через пакетный менеджер;
     > (для Debian-based дистрибутивов и Ubuntu: `sudo apt-get install python3-dev`).

После установки ПО из предварительных требований рекомендуется перезагрузить компьютер для применения изменений.

## Установка проекта
1. Склонировать проект, или загрузить архивную версию проекта и распаковать из неё папку HockeyMinimapServer, 
   являющуюся корнем проекта:
   1. При отсутствии файлов с расширением .pth в папке models проект не может быть запущен, поэтому.
      требуется загрузить и вручную добавить их в эту папку:
      - Файл FieldDetector.pth по умолчанию отвечает за модель Detectron2, размечающую элементы поля;
      - Файл PlayersDetector.pth по умолчанию отвечает за определение расположений игроков и рефери на поле.
2. Подготовка окружения:
   * Создать виртуальное окружение в корне проекта
     командой `python -m venv venv` или аналог для Linux `python3 -m venv venv`.
   ### Для Windows:
      - Активировать виртуальное окружение с помощью команды `./venv/Scripts/activate`.
   ### Для Linux:
      - Активировать виртуальное окружение командой `source ./venv/bin/activate`.
3. В корне проекта выполнить `pip install -e .`.
   > При необходимости дополнительных зависимостей для разработчика можно использовать 
   > `pip install -e ".[uvicorn,linters,dev]"`.
4. Запустить пост-установочный скрипт командой `python post_install.py` для установки доп. зависимостей:
   - На выбор будут предложены варианты поддерживаемых операционной системой бэкэндов pytorch,
     из которых нужно выбрать с помощью ввода номера варианта в списке и нажатия enter для подтверждения,
     после чего начнется установка pytorch, и отдельно установка Detectron2.
   - По умолчанию выбранный бэкэнд - CPU, который будет выбрать при пустом вводе, 
     или вводе несуществующего в списке номера.

## Обзорная структура хранимых файлов и папок
* `./server` - хранит исходный код сервера и абстракций для его работы;
* `./models` - содержит папку по умолчанию для хранения моделей Detectron2;
* `./static` - содержит статические ресурсы по умолчанию,
  и переносится на другой диск только с сохранением её структуры:
  * `./static/map.png` - исходное изображение мини-карты, используемое для отрисовки видео и расчетов;
  * `./static/videos` - папка для хранения ресурсов обрабатываемых видео;
  * `./static/videos/<UUID>` - отдельная папка конкретного загруженного видео и дополнительных ресурсов для обработки:
    * `./static/videos/<UUID>/source_video.mp4` - исходное загруженное видео, транскодированное в формат для браузеров;
    * `./static/videos/<UUID>/corrected_video.mp4` - видео со скорректированной бочкообразной дисторсией;
    * `./static/videos/<UUID>/field_mask.jpeg` - маска поля, обязательно требуемая для получения позиций игроков; 
      > Получается при вызове эндпоинта `/video/{video_id}/map_points/inference`.
    * `./static/videos/<UUID>/project_data.json` - экспортированные данные проекта.
      > Полученные при вызове `/projects/{project_id}/export`.
    * `./static/videos/<UUID>/export.zip` - экспортированные данные и ресурсы проекта.
      > Полученные при вызове `/projects/{project_id}/export` и используются для полного восстановления проектов.
* `./tests` - содержит Unit-тесты для репозиториев
  > Требуется установка dev-зависимостей, см. пункт 3 установки проекта.
* `./docs` - папка для генерации документации из исходного кода.
  Для генерации документации необходимо вызвать `make html` или другой формат вывода, поддерживаемый sphinx;
  > Добавлена зависимость для генерации word файлов через docx.
  > Требуется установка dev-зависимостей.
* `config.toml` - конфигурационный файл по умолчанию, 
  не создающий постоянной базы данных и используемый для тестирования.

## Запуск проекта
1. Активировать виртуальное окружение, как было описано ранее в пункте 2, "Установка проекта"
2. Запустить команду `python -m server`
3. Для завершения работы нажать сочетание клавиш в консоли CTRL+C

По умолчанию запуск производится с настройками, предполагающими локальное временное использование, 
и данные не будут сохранены без изменения конфигурации.

Аргументы запуска (следуют за командой обычного запуска):
* --help -h - выводит сообщение с помощью по аргументам
* --init-db - инициализирует файл базы данных таблицами
* --drop-db - удаляет таблицы из файла базы данных со всеми данными
* --config -c <CONFIG_PATH> - указывает путь до файла конфигурации, с которым будет запущено приложение
* --local-mode - запускает сервер в режиме локального доступа

Пример команды: `python -m server --help`

### Локальный режим доступа
Режим локального доступа - особый режим, имеющий одного пользователя, не внесенного в базу данных, под именем Admin и 
не имеющего пароля. Он имеет все права, и требуется для первичного создания пользователей.

**По умолчанию данный режим включен в конфигурации, и для использования по сети для безопасности его следует отключить.**

### Конфигурирование
Рекомендуется создать отдельный файл конфигурации на основе предоставляемого в репозитории, скопировав изначальный файл
и изменять параметры в нем, после чего применять его на момент запуска командой `python -m server -c ./config.toml`,
где `./config.toml` заменен на пользовательский файл.

#### Параметры конфигурации:
* local_mode - Отвечает за то, запущен ли сервер в режиме локального доступа или нет (по умолчанию true);
* db_connection_string - Строка подключения к базе данных, 
  передается в [SQLAlchemy](https://docs.sqlalchemy.org/en/20/core/engines.html);
  > Для получения постоянного хранения данных необходимо заменить `:memory:` на имя файла, 
  > и запустить сервер через аргумент init-db `python -m server --init-db`.

  > Для баз данных, отличных от SQLite требуется дополнительная установка модулей, в соответствии с документацией по async
  > SQLAlchemy, поскольку применяется асинхронная версия запросов.
* enable_gzip_compression - необходимо для включения сжатия передаваемых данных 
  на стороне Python-сервера (по умолчанию true);
  > Данную опцию необходимо выключать при использовании reverse-proxy (прим. nginx),
  поскольку они эффективнее сжимают данные и могут занимать меньше ресурсов.
* server_jwt_key - ключ подписи JWT-токенов, необходимый для проверки подлинности токенов доступа, 
  **необходимо изменить с параметра по умолчанию;**
* static_path - путь до папки со статическими ресурсами (по умолчанию ./static от корня проекта);
* players_data_extraction_workers - количество обработчиков данных игроков;
* minimap_frame_buffer - количество кадров в буфере для вывода на диск;
  > Каждый кадр ~= 1.5 МБ ОЗУ * minimap_rendering_workers в пиковой нагрузке.
* prefetch_frame_buffer - количество кадров в буфере на обработку видео;
  > Каждый кадр ~= 1.5 МБ ОЗУ * video_processing_workers в пиковой нагрузке.
* minimap_rendering_workers - количество параллельных выводов мини-карты, которые могут обрабатываться;
* video_processing_workers - количество обработчиков видео, получающих примеры формы игроков 
  или делающих выборку перемещений игроков;
##### Секция nn_config:
* field_detection_model_path - путь до модели определения элементов поля;
* player_detection_model_path - путь до модели определения игроков на поле;
* max_batch_size - максимальное количество параллельно обрабатываемых кадров нейросетью;
##### Секция server_settings:
* host - ограничение, откуда принимаются запросы;
* port - порт запускаемого сервера;
* reload_dirs - необходимо ли динамически перезагружать директорию статических файлов;
  > При использовании раздачи файлов из static силами nginx - установить в значение false.
* allowed_cors_domains - список доверенных доменов, которым разрешено выполнять запросы к серверу;
  > Необходимо для обеспечения доступа из браузеров.
##### Секция video_processing:
* hwaccel - выбранный аппаратный ускоритель из параметров FFMpeg;
* codec - кодировщик видео, выбранный для FFMpeg;
* hwaccel_output_format - в каком формате хранятся кадры;
  > Для аппаратных декодировщиков необходимо выбрать подходящий, 
  > иначе будет использоваться передача данных через процессор, что замедляет обработку.
* video_width - максимальная ширина видео (делимая на 2);
* video_height - максимальная высота видео (делимая на 2);
* preset - пресет качества кодирования видео (быстрее - больше объем файла);
  > Применим только для процессоров в качестве кодировщика.
* crf - качество перекодированного видео (меньше - лучше);
* target_bitrate - целевой битрейт видео;
* maxrate - максимальный битрейт видео;
* bufsize - на протяжении какого объема FFMpeg отслеживает битрейт;
* loglevel - уровень вывода от FFMpeg в консоль;
##### Секция minimap_config (конфигурация ключевых точек на карте):
* top_left_field_point - верхняя левая точка, вмещающая в себя игровое поля на карте;
* bottom_right_field_point - правая нижняя точка, вмещающая в себя игровое поля на карте;
* left_goal_zone - точка центра левой зоны гола;
* right_goal_zone - точка центра правой зоны гола;
* center_line_top - верхняя точка центральной линии поля;
* center_line_bottom - нижняя точка центральной линии поля;
* left_blue_line_top - верхняя точка левой синей линии;
* left_blue_line_bottom - нижняя точка левой синей линии;
* right_blue_line_top - верхняя точка правой синей линии;
* right_blue_line_bottom - нижняя точка правой синей линии;
* left_goal_line_top - верхняя точка верхней половины левой линии зоны гола;
* left_goal_line_bottom - нижняя точка верхней половины левой линии зоны гола;
* left_goal_line_after_zone_top - верхняя точка нижней половины левой линии зоны гола;
* left_goal_line_after_zone_bottom - нижняя точка нижней половины левой линии зоны гола;
* right_goal_line_top - верхняя точка верхней половины правой линии зоны гола;
* right_goal_line_bottom - нижняя точка верхней половины правой линии зоны гола;
* right_goal_line_after_zone_top - верхняя точка нижней половины правой линии зоны гола;
* right_goal_line_after_zone_bottom - нижняя точка нижней половины правой линии зоны гола;
* red_circle_top_left - центр левого верхнего красного круга;
* red_circle_top_right - центр правого верхнего красного круга;
* red_circle_bottom_left - центр левого нижнего красного круга;
* red_circle_bottom_right - центр правого нижнего красного круга;
* center_circle - центр центрального круга.

## Особенности сервера в поведении:
* Все идентификаторы, связанные с кадрами, представляют собой индексы, 
  и, следовательно, включают оба конца в качестве валидных идентификаторов [n, n+k].
* Получение данных из поднаборов данных о форме не группирует информацию по кадрам, а получает её цельным списком,
  из-за чего может потребоваться объединение в группы по кадрам на клиенте;
* Получение информации о точках от сервера не сохраняет информацию о точках в базу данных. Требуется ручная отправка.
* Описание используемых перечислений, передаваемых как числа для задания классов или команд не доступно по адресу
  документации по умолчанию http://localhost:8000/docs/,
  но доступно в альтернативной документации по адресу http://localhost:8000/redoc.
* Авторизация и проверка пользователя производится при помощи токена, передаваемого через cookie с названием
  user_token со значением токена, и срок доступности данных по токену составляет 7 дней.